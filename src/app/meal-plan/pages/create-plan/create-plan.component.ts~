import { Component, OnInit } from '@angular/core';
import {FormBuilder, FormGroup, Validators, FormArray, ReactiveFormsModule} from '@angular/forms';
import {MatCardModule} from '@angular/material/card';
import {MatInputModule} from '@angular/material/input';
import {NgForOf} from '@angular/common';
import {MatButton, MatIconButton} from '@angular/material/button';
import {MatSelectModule} from '@angular/material/select';
import {MatFormFieldModule} from '@angular/material/form-field';
import {Recipe} from '../../model/meal-plan.entity';
import {UserService} from '../../../user/services/user.service';
import {MealPlanService} from '../../services/meal-plan.service';
import {MatIcon} from '@angular/material/icon';
import {MatExpansionModule} from '@angular/material/expansion';

@Component({
  selector: 'app-create-plan',
  imports: [MatCardModule, ReactiveFormsModule, MatSelectModule, MatInputModule, NgForOf,
    MatButton, MatFormFieldModule, MatIcon, MatExpansionModule, MatIconButton],
  templateUrl: './create-plan.component.html',
  styleUrl: './create-plan.component.css'
})
export class CreatePlanComponent implements OnInit {
  mealPlanForm: FormGroup;
  daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
  mealTimes = ['Desayuno', 'Almuerzo', 'Cena'];
  allRecipes: Recipe[] = [];
  availableRecipes: any;
  meals: any;
  days:any;

  constructor(private fb: FormBuilder,private userService: UserService, private mealPlanService: MealPlanService) {
    this.mealPlanForm = this.fb.group({
      name: ['', Validators.required],
      category: ['', Validators.required],
      description: [''],
      goal: ['', Validators.required],
      min_bmi: ['', [Validators.required, Validators.min(10)]],
      max_bmi: ['', [Validators.required, Validators.max(60)]],
      min_age: ['', [Validators.required, Validators.min(1)]],
      max_age: ['', [Validators.required, Validators.max(120)]],
      calories_per_day: ['', Validators.required],
      recipesByDay: this.fb.array([])
    });

    this.initRecipePlanStructure();

  }

  ngOnInit(): void {
  this.fetchAllRecipes();
  }

  fetchAllRecipes() {
    this.mealPlanService.getAllRecipes().subscribe({
      next: (recipes) => {
        this.allRecipes = recipes;
        console.log('Recetas disponibles:', this.allRecipes);
        this.availableRecipes = this.allRecipes.map(recipe => ({
          id: recipe.id,
          title: recipe.title
        }));
      },
      error: (err) => {
        console.error('Error fetching recipes:', err);
      }
    })
  }
  getMealsControls(dayIndex: number): FormArray {
    return this.recipesByDay.at(dayIndex).get('meals') as FormArray;
  }

  get recipesByDay(): FormArray {
    return this.mealPlanForm.get('recipesByDay') as FormArray;
  }

  initRecipePlanStructure() {
    this.daysOfWeek.forEach(day => {
      this.recipesByDay.push(
        this.fb.group({
          day: [day],
          meals: this.fb.array(
            this.mealTimes.map(meal =>
              this.fb.group({
                meal_time: [meal],
                recipe_id: [null]
              })
            )
          )
        })
      );
    });
  }
  /*addMeal(){
    const meals = this.recipesByDay.at(0).get('meals') as FormArray;
    meals.push(
      this.fb.group({
        meal_time: [''],
        recipe_id: ['']
      })
    );
  }*/
/*  addMeal(dayIndex: number) {
    const meals = this.getMealsControls(dayIndex);
    meals.push(this.mealPlanForm());
  }*/

  removeMeal(dayIndex: number, mealIndex: number) {
    const meals = this.getMealsControls(dayIndex);
    meals.removeAt(mealIndex);
  }
  cancel(){
/*    this.mealPlanForm.reset();
    this.initRecipePlanStructure();*/
  }
/*  onSubmit() {
    if (this.mealPlanForm.valid) {
      const data = this.mealPlanForm.value;
      console.log('Plan enviado:', data);
      // Aquí harías el POST al backend
    } else {
      this.mealPlanForm.markAllAsTouched();
    }
  }*/

onSubmit() {
  if (this.mealPlanForm.valid) {
    const mealPlan: any = {
      name: this.mealPlanForm.value.name,
      category: this.mealPlanForm.value.category,
      description: this.mealPlanForm.value.description,
      goal: this.mealPlanForm.value.goal,
      min_bmi: this.mealPlanForm.value.min_bmi,
      max_bmi: this.mealPlanForm.value.max_bmi,
      min_age: this.mealPlanForm.value.min_age,
      max_age: this.mealPlanForm.value.max_age,
      calories_per_day: this.mealPlanForm.value.calories_per_day,
      nutricionist_id: this.userService.getUserId(),
    };

    this.mealPlanService.saveMealPlan(mealPlan).subscribe({
      next: (savedMealPlan) => {
        const mealPlanId = savedMealPlan.id;
        const recipesByDay: any[] = [];

        this.mealPlanForm.value.recipesByDay.forEach((day: any) => {
          day.meals.forEach((meal: any) => {
            recipesByDay.push({
              day: day.day,
              meal_time: meal.meal_time,
              recipe_id: meal.recipe_id,
              meal_plan_id: mealPlanId,
            });
          });
        });

        this.mealPlanService.saveRecipesByDay(recipesByDay)
      },
      error: (err) => {
        console.error('Error al guardar el plan de comidas:', err);
      },
    });
  } else {
    this.mealPlanForm.markAllAsTouched();
  }
}
}
